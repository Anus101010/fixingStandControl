-- Player: Auto Sprint, Player ESP, Character Modifications (Player Fly + Fly Speed)
-- Misc: Dash, Waypoint, Keybinds (Fly = RightShift)

local Xenon = { Utils = {} }
Xenon.__index = Xenon
Xenon.Utils.__index = Xenon.Utils

local Library = loadstring(game:HttpGet("https://pastebin.com/raw/9YwM8kt6"))()

function Xenon.Utils.MakeUtilController()
    local Utils = {
        Tasks = {};
        Services = {};
        States = {};
        Ints = {};
    }
    Utils.Services = setmetatable({}, {
        __index = function(self, service)
            if rawget(self, service) then return rawget(self, service) end
            self[service] = game:GetService(service)
            return self[service]
        end
    })
    return setmetatable(Utils, Xenon.Utils)
end

function Xenon.Utils:GetService(Service) return self.Services[Service] end
function Xenon.Utils:GetPlayer() return self:GetService("Players").LocalPlayer end
function Xenon.Utils:GetCharacter() return self:GetPlayer().Character or self:GetPlayer().CharacterAdded:Wait() end
function Xenon.Utils:GetHumanoid()
    local c = self:GetCharacter()
    return c and c:FindFirstChildWhichIsA("Humanoid")
end
function Xenon.Utils:GetHRP()
    local c = self:GetCharacter()
    return c and c:FindFirstChild("HumanoidRootPart")
end
function Xenon.Utils:GetHorse()
    local n = self:GetPlayer().Name
    return workspace:FindFirstChild(n .. "'s Horse")
end
function Xenon.Utils:GetState(Value) return self.States[Value] and self.States[Value].Value end
function Xenon.Utils:SetState(Value, NewValue) if self.States[Value] then self.States[Value].Value = NewValue end end
function Xenon.Utils:GetInt(Value) return self.Ints[Value] and self.Ints[Value].Value end
function Xenon.Utils:SetInt(Value, NewValue) if self.Ints[Value] then self.Ints[Value].Value = NewValue end end
function Xenon.Utils:AddTask(TaskName, Task)
    if not self.Tasks[TaskName] then self.Tasks[TaskName] = Task end
    return Task
end
function Xenon.Utils:IsTaskRunning(TaskName) return self.Tasks[TaskName] and self.Tasks[TaskName].Connected end
function Xenon.Utils:DisconnectTask(TaskName)
    if self:IsTaskRunning(TaskName) then self.Tasks[TaskName]:Disconnect() self.Tasks[TaskName] = nil end
end

function Xenon.Utils:GetStroke()
    local Dir, Anim = 180, "6926086304"
    local UIS = game:GetService("UserInputService")
    if UIS:IsKeyDown(Enum.KeyCode.A) then Dir, Anim = 90, "6926086567"
    elseif UIS:IsKeyDown(Enum.KeyCode.D) then Dir, Anim = -90, "6926086883"
    elseif UIS:IsKeyDown(Enum.KeyCode.W) then Dir, Anim = 0, "6926086032"
    end
    return Dir, Anim
end

function Xenon.Utils:Outline(Chars)
    local h = Instance.new("Highlight", self:GetService("CoreGui").GayESP)
    h.OutlineColor = Color3.fromRGB(255,255,255)
    h.Adornee = Chars
    h.FillColor = Color3.fromRGB(255,255,255)
    h.FillTransparency = 1
end

function Xenon.Utils:LabelChar(Chars)
    local bg = Instance.new("BillboardGui", self:GetService("CoreGui").GayESP)
    local fr = Instance.new("Frame", bg)
    local lb = Instance.new("TextLabel", fr)
    bg.Adornee = Chars:WaitForChild("Head")
    bg.StudsOffset = Vector3.new(0,3,0)
    bg.AlwaysOnTop = true
    bg.Size = UDim2.new(4,0,0.5,0)
    fr.Size = UDim2.new(1,0,1,0)
    lb.Size = UDim2.new(1,0,1,0)
    fr.BackgroundTransparency = 1
    lb.BackgroundTransparency = 1
    lb.Text = Chars.Name
    lb.Font = Enum.Font.Ubuntu
    lb.TextColor3 = Color3.fromRGB(255,255,255)
end

local Util = Xenon.Utils.MakeUtilController()
Util.States["Auto Sprinting"] = { Value = false }
Util.States["Infinite Dash"] = { Value = false }
Util.States["Fly"] = { Value = false }
Util.Ints["InfTick"] = { Value = tick() }
Util.Ints["InfDelay"] = { Value = 1 }
Util.Ints["DashPower"] = { Value = 50 }
Util.Ints["FlySpeed"] = { Value = 0.5 }

local Lib = Library.CreateLib()
local PlayerTab = Lib:Tab("Player", 6023426915)
local MiscTab = Lib:Tab("Misc", 6022668951)

-- Player: только Auto Sprint и Player ESP
local Player_Section = PlayerTab:Section("Player")

Player_Section:Toggle("Auto Sprint", false, function(State)
    Util:SetState("Auto Sprinting", State)
    while Util:GetState("Auto Sprinting") == true and Util:GetCharacter() do
        task.wait()
        pcall(function()
            local c = Util:GetCharacter()
            if c and c:FindFirstChild("RemoteFunction") then
                local r = c.RemoteFunction:InvokeServer("ReturnSprint")
                if r and r.IsSprinting ~= true then c.RemoteFunction:InvokeServer("ToggleSprinting") end
            end
        end)
    end
end, "Toggles auto sprint")

Player_Section:Toggle("Player ESP", false, function(State)
    if State then
        Instance.new("Folder", Util:GetService("CoreGui")).Name = "GayESP"
        for _, v in pairs(Util:GetService("Players"):GetPlayers()) do
            if v ~= Util:GetPlayer() then
                Util:AddTask("Chr", v.CharacterAdded:Connect(function(ch) Util:Outline(ch) Util:LabelChar(ch) end))
                if v.Character then Util:Outline(v.Character) Util:LabelChar(v.Character) end
            end
        end
        Util:AddTask("Chr2", Util:GetService("Players").PlayerAdded:Connect(function(p)
            p.CharacterAdded:Connect(function(ch) Util:Outline(ch) Util:LabelChar(ch) end)
        end))
    else
        local g = Util:GetService("CoreGui"):FindFirstChild("GayESP")
        if g then g:Destroy() end
        Util:DisconnectTask("Chr") Util:DisconnectTask("Chr2")
    end
end, "Turns on name ESP for players")

-- Character Modifications: Player Fly + Fly Speed (логика из xenonv3_source)
local Player_CM = PlayerTab:Section("Character Modifications")
local FlyToggleRef = Player_CM:Toggle("Player Fly", false, function(State)
    if State == true then
        Library:Notification("Player Fly", "Fly enabled!", 3)
        local Keys_Pressed = {
            ["W"] = 0;
            ["A"] = 0;
            ["S"] = 0;
            ["D"] = 0;
        }
        local Key_Info = {
            ["W"] = { ["Operator"] = "+"; ["Direction"] = "LookVector"; };
            ["A"] = { ["Operator"] = "-"; ["Direction"] = "RightVector"; };
            ["S"] = { ["Operator"] = "-"; ["Direction"] = "LookVector"; };
            ["D"] = { ["Operator"] = "+"; ["Direction"] = "RightVector"; };
        }
        local UIS = game:GetService("UserInputService")
        local function GetKeyFromEnum(enum) return enum.KeyCode.Name end
        local function GetMass(Model)
            local Mass = 0
            for _, v in pairs(Model:GetDescendants()) do if v:IsA("BasePart") then Mass = Mass + v:GetMass() end end
            return Mass
        end
        local function Math(Operator, A, B) if Operator == "-" then return A - B elseif Operator == "+" then return A + B end end
        if UIS:IsKeyDown(Enum.KeyCode.W) then Keys_Pressed["W"] = 1
        elseif UIS:IsKeyDown(Enum.KeyCode.A) then Keys_Pressed["A"] = 1
        elseif UIS:IsKeyDown(Enum.KeyCode.S) then Keys_Pressed["S"] = 1
        elseif UIS:IsKeyDown(Enum.KeyCode.D) then Keys_Pressed["D"] = 1
        end
        Util:AddTask("FlyThingy", UIS.InputBegan:Connect(function(Key, Typing)
            if Typing then return end
            local Key_String = GetKeyFromEnum(Key)
            if Keys_Pressed[Key_String] ~= nil then Keys_Pressed[Key_String] = 1 end
        end))
        Util:AddTask("FlyThingy2", UIS.InputEnded:Connect(function(Key, Typing)
            if Typing then return end
            local Key_String = GetKeyFromEnum(Key)
            if Keys_Pressed[Key_String] ~= nil then Keys_Pressed[Key_String] = 0 end
        end))
        Util:AddTask("FlyLoop", game:GetService("RunService").RenderStepped:Connect(function()
            if Util:GetHorse() == nil or Util:GetHorse().Seat.Occupant ~= Util:GetCharacter():FindFirstChildWhichIsA("Humanoid") then
                Util:GetHumanoid().WalkSpeed = 0
                Util:GetHumanoid().JumpPower = 0
                Util:GetHRP().CFrame = CFrame.new(Util:GetHRP().Position, Util:GetHRP().Position + workspace.CurrentCamera.CFrame.LookVector)
                local CharacterMass = GetMass(Util:GetCharacter())
                local Velocity = Vector3.new(0, CharacterMass / workspace.Gravity, 0)
                for i, v in pairs(Keys_Pressed) do
                    if v ~= 0 and Key_Info[i] then Velocity = Math(Key_Info[i].Operator, Velocity, Util:GetHRP().CFrame[Key_Info[i].Direction] * (Util:GetInt("FlySpeed") * 25) * CharacterMass) end
                end
                Util:GetHRP().Velocity = Velocity
            elseif Util:GetHorse() ~= nil and Util:GetHorse().Seat.Occupant == Util:GetCharacter():FindFirstChildWhichIsA("Humanoid") then
                local horse = Util:GetHorse()
                horse.Humanoid.WalkSpeed = 0
                horse.Humanoid.JumpPower = 0
                if horse:FindFirstChild("Speed") then horse.Speed.Value = 0 end
                horse.PrimaryPart.CFrame = CFrame.new(horse.PrimaryPart.Position, horse.PrimaryPart.Position + workspace.CurrentCamera.CFrame.LookVector)
                local CharacterMass = GetMass(horse)
                local Velocity = Vector3.new(0, CharacterMass / workspace.Gravity, 0)
                for i, v in pairs(Keys_Pressed) do
                    if v ~= 0 and Key_Info[i] then Velocity = Math(Key_Info[i].Operator, Velocity, horse.PrimaryPart.CFrame[Key_Info[i].Direction] * (Util:GetInt("FlySpeed") * 25) * CharacterMass) end
                end
                horse.PrimaryPart.Velocity = Velocity
            end
        end))
    else
        Library:Notification("Player Fly", "Fly disabled!", 3)
        Util:DisconnectTask("FlyLoop")
        Util:DisconnectTask("FlyThingy")
        Util:DisconnectTask("FlyThingy2")
        local hum = Util:GetHumanoid()
        if hum then hum.WalkSpeed = 16 end
    end
end, "Toggles player fly")
Player_CM:Slider("Fly Speed", 0.1, 1, 0.5, function(V) Util:SetInt("FlySpeed", V) end, true, "changes fly speed")

-- Misc: Dash + Spawnpoint + Keybinds
local Misc_Dash = MiscTab:Section("Dash")
local DashAnimsFolder = Instance.new("Folder", workspace)

Misc_Dash:Toggle("Infinite Dash", false, function(State)
    Util:SetState("Infinite Dash", State)
    if Util:GetState("Infinite Dash") == true then
        Util:AddTask("InfDash", game:GetService("UserInputService").InputBegan:Connect(function(Input, GameProcessed)
            if GameProcessed then return end
            local plr = Util:GetPlayer()
            if not plr.Character then return end
            local dk = plr:FindFirstChild("PlayerStats") and plr.PlayerStats:FindFirstChild("DashKey")
            if not dk then return end
            if Input.KeyCode == Enum.KeyCode[dk.Value] and (tick() - Util:GetInt("InfTick")) >= Util:GetInt("InfDelay") then
                Util:SetInt("InfTick", tick())
                local Dir, AnimId = Util:GetStroke()
                local anim = Instance.new("Animation", DashAnimsFolder)
                anim.AnimationId = "rbxassetid://" .. AnimId
                Util:GetHumanoid():LoadAnimation(anim):Play()
                local bv = Instance.new("BodyVelocity", Util:GetHRP())
                bv.Velocity = (Util:GetHRP().CFrame * CFrame.Angles(0, math.rad(Dir), 0)).LookVector * Util:GetInt("DashPower")
                bv.MaxForce = Vector3.new(55555, 1000, 55555)
                game:GetService("Debris"):AddItem(bv, 0.25)
            end
        end))
    else
        Util:DisconnectTask("InfDash")
    end
end, "Toggles custom dash")

Misc_Dash:Slider("Dash Power", 10, 1000, 50, function(V) Util:SetInt("DashPower", V) end, false, "Set dash power")
Misc_Dash:Slider("Dash Delay", 0, 3.5, 1, function(V) Util:SetInt("InfDelay", V) end, true, "Set dash delay")

-- Misc: Waypoint — полная вкладка из xenonv3_source (Waypoint + Spawnpoint)
local Misc_Waypoints = MiscTab:Section("Waypoint")
local Cache = { ["Waypoint"] = nil, ["Spawnpoint"] = nil }

local WaypointStatus = Misc_Waypoints:Label("Waypoint: None")

Misc_Waypoints:Button("Set Waypoint", function()
    local Char = Util:GetCharacter()
    if Char and Char.PrimaryPart then
        Cache["Waypoint"] = Char.PrimaryPart.CFrame
        WaypointStatus:UpdateAsset("Waypoint: " .. tostring(math.round(Char.PrimaryPart.Position.X)) .. ", " .. tostring(math.round(Char.PrimaryPart.Position.Y)) .. ", " .. tostring(math.round(Char.PrimaryPart.Position.Z)))
    end
end, "Sets your waypoint to your current position.")

Misc_Waypoints:Button("Go to waypoint", function()
    local Char = Util:GetCharacter()
    if Cache["Waypoint"] ~= nil and Char and Char.PrimaryPart then
        Char.PrimaryPart.CFrame = Cache["Waypoint"]
    end
end, "Teleports you to your current waypoint")

local SpawnpointStatus = Misc_Waypoints:Label("Spawnpoint: Default")

Misc_Waypoints:Button("Set Spawnpoint", function()
    local Char = Util:GetCharacter()
    if Char and Char.PrimaryPart then
        Cache["Spawnpoint"] = Char.PrimaryPart.CFrame
        SpawnpointStatus:UpdateAsset("Spawnpoint: " .. tostring(math.round(Char.PrimaryPart.Position.X)) .. ", " .. tostring(math.round(Char.PrimaryPart.Position.Y)) .. ", " .. tostring(math.round(Char.PrimaryPart.Position.Z)))
        Util:AddTask("Spawnpoint", Util:GetPlayer().CharacterAdded:Connect(function(Chara)
            task.wait(0.15)
            if Chara and Chara.PrimaryPart and Cache["Spawnpoint"] then
                Chara.PrimaryPart.CFrame = Cache["Spawnpoint"]
            end
        end))
    end
end, "Sets your waypoint to your current position.")

Misc_Waypoints:Button("Reset Spawnpoint", function()
    Util:DisconnectTask("Spawnpoint")
    Cache["Spawnpoint"] = nil
    SpawnpointStatus:UpdateAsset("Spawnpoint: Default")
end, "Resets your spawn point to default spawns.")

-- Misc: Keybinds — Fly на RightShift (как в xenonv3_source: только переключает тогл в UI)
local Misc_Keybinds = MiscTab:Section("Keybinds")
Misc_Keybinds:Keybind("Fly", Enum.KeyCode.RightShift, function()
    if Util:IsTaskRunning("FlyLoop") == nil or not Util:IsTaskRunning("FlyLoop") then
        pcall(function() FlyToggleRef:UpdateAsset(true) end)
    else
        pcall(function() FlyToggleRef:UpdateAsset(false) end)
    end
end, "Toggle fly")

pcall(function()
    local gui = game:GetService("CoreGui"):FindFirstChild("XenonV3Lib")
    if gui and gui:FindFirstChild("TabHolder") and gui.TabHolder:FindFirstChild("Status") then
        gui.TabHolder.Status.Label.Text = "Status: Loaded!"
    end
end)
